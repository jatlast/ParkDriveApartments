- id: pkdr_lights_on
  alias: Building Lights On
  description: Turn ON all the common area lights before sunset
  trigger:
  - platform: numeric_state
    entity_id: sun.sun
    attribute: elevation
    below: '0'
  condition: []
  action:
  - service: switch.turn_on
    data: {}
    target:
      entity_id:
      - switch.b1_lights
      - switch.b2_lights
      - switch.b3_lights
      - switch.b4_lights
  mode: single

- id: pkdr_lights_off
  alias: Building Lights Off
  description: Turn OFF all the common area lights before sunset
  trigger:
  - platform: numeric_state
    entity_id: sun.sun
    attribute: elevation
    above: '0'
  condition: []
  action:
  - service: switch.turn_off
    data: {}
    target:
      entity_id:
      - switch.b1_lights
      - switch.b2_lights
      - switch.b3_lights
      - switch.b4_lights
  mode: single

- id: pkdr_lights_on_revert
  alias: Building Lights Back On
  trigger:
  - platform: time_pattern
    minutes: 15
    seconds: 00
  condition:
    condition: or  # 'when dark' condition: either after sunset or before sunrise
    conditions:
      - condition: sun
        after: sunset
      - condition: sun
        before: sunrise
  action:
  - service: switch.turn_on
    entity_id: group.building_lights

- id: pkdr_lights_off_revert
  alias: Building Lights Back Off
  trigger:
  - platform: time_pattern
    minutes: 30
    seconds: 00
  condition:
    condition: or  # 'when dark' condition: either after sunset or before sunrise
    conditions:
      - condition: sun
        after: sunrise
      - condition: sun
        before: sunset
  action:
  - service: switch.turn_off
    entity_id: group.building_lights

- id: apt01_volume_changed
  alias: Apt01 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt01_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt01/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt01_volume') | int }}"

- id: apt02_volume_changed
  alias: Apt02 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt02_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt02/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt02_volume') | int }}"

- id: apt03_volume_changed
  alias: Apt03 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt03_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt03/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt03_volume') | int }}"

- id: apt04_volume_changed
  alias: Apt04 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt04_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt04/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt04_volume') | int }}"

- id: apt05_volume_changed
  alias: Apt05 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt05_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt05/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt05_volume') | int }}"

- id: apt06_volume_changed
  alias: Apt06 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt06_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt06/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt06_volume') | int }}"

- id: apt07_volume_changed
  alias: Apt07 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt07_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt07/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt07_volume') | int }}"

- id: apt08_volume_changed
  alias: Apt08 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt08_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt08/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt08_volume') | int }}"

- id: apt09_volume_changed
  alias: Apt09 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt09_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt09/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt09_volume') | int }}"

- id: apt10_volume_changed
  alias: Apt10 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt10_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt10/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt10_volume') | int }}"

- id: apt11_volume_changed
  alias: Apt11 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt11_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt11/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt11_volume') | int }}"

- id: apt12_volume_changed
  alias: Apt12 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt12_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt12/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt12_volume') | int }}"

- id: apt13_volume_changed
  alias: Apt13 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt13_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt13/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt13_volume') | int }}"

- id: apt14_volume_changed
  alias: Apt14 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt14_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt14/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt14_volume') | int }}"

- id: apt15_volume_changed
  alias: Apt15 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt15_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt15/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt15_volume') | int }}"

- id: apt16_volume_changed
  alias: Apt16 Volume Changed
  trigger:
    platform: state
    entity_id: input_number.apt16_volume
  action:
  - service: mqtt.publish
    data:
      topic: PkDr/Apt16/Doorbell/stat/Volume/setVolume
      retain: true
      payload: "{{ states('input_number.apt16_volume') | int }}"

- id: apt01_no_ac_with_heat
  alias: Apt01 No AC with Heat
  trigger:
    - platform: state
      entity_id: switch.apt01_ac
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.01_heat

- id: apt01_no_heat_with_ac
  alias: Apt01 No Heat with AC
  trigger:
    - platform: state
      entity_id: switch.01_heat
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.apt01_ac

- id: apt02_no_ac_with_heat
  alias: Apt02 No AC with Heat
  trigger:
    - platform: state
      entity_id: switch.apt02_ac
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.02_heat

- id: apt02_no_heat_with_ac
  alias: Apt02 No Heat with AC
  trigger:
    - platform: state
      entity_id: switch.02_heat
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.apt02_ac

- id: apt03_no_ac_with_heat
  alias: Apt03 No AC with Heat
  trigger:
    - platform: state
      entity_id: switch.apt03_ac
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.03_heat

- id: apt03_no_heat_with_ac
  alias: Apt03 No Heat with AC
  trigger:
    - platform: state
      entity_id: switch.03_heat
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.apt03_ac

- id: apt05_no_ac_with_heat
  alias: Apt05 No AC with Heat
  trigger:
    - platform: state
      entity_id: switch.apt05_ac
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.05_heat

- id: apt05_no_heat_with_ac
  alias: Apt05 No Heat with AC
  trigger:
    - platform: state
      entity_id: switch.05_heat
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.apt05_ac

- id: apt06_no_ac_with_heat
  alias: Apt06 No AC with Heat
  trigger:
    - platform: state
      entity_id: switch.apt06_ac
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.06_heat

- id: apt06_no_heat_with_ac
  alias: Apt06 No Heat with AC
  trigger:
    - platform: state
      entity_id: switch.06_heat
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.apt06_ac

- id: apt07_no_ac_with_heat
  alias: Apt07 No AC with Heat
  trigger:
    - platform: state
      entity_id: switch.apt07_ac
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.07_heat

- id: apt07_no_heat_with_ac
  alias: Apt07 No Heat with AC
  trigger:
    - platform: state
      entity_id: switch.07_heat
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.apt07_ac

- id: apt09_no_ac_with_heat
  alias: Apt09 No AC with Heat
  trigger:
    - platform: state
      entity_id: switch.09_ac
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.09_heat

- id: apt09_no_heat_with_ac
  alias: Apt09 No Heat with AC
  trigger:
    - platform: state
      entity_id: switch.09_heat
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.apt09_ac

- id: apt12_no_ac_with_heat
  alias: Apt12 No AC with Heat
  trigger:
    - platform: state
      entity_id: switch.apt12_ac
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.12_heat

- id: apt12_no_heat_with_ac
  alias: Apt12 No Heat with AC
  trigger:
    - platform: state
      entity_id: switch.12_heat
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.apt12_ac

- id: apt14_no_ac_with_heat
  alias: Apt14 No AC with Heat
  trigger:
    - platform: state
      entity_id: switch.apt14_ac
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.14_heat

- id: apt14_no_heat_with_ac
  alias: Apt14 No Heat with AC
  trigger:
    - platform: state
      entity_id: switch.14_heat
      to: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.apt14_ac

- id: b1_entrance_relock
  alias: B1 Entrance Relock
  trigger:
    platform: state
    entity_id: switch.b1_entrance_lock
    to: 'on'
    for:
      minutes: 1
  action:
  - service: switch.turn_off
    entity_id: switch.b1_entrance_lock

- id: apt01_entrance_relock
  alias: Apt01 Entrance Relock
  trigger:
    platform: state
    entity_id: switch.apt01_entrance_lock
    to: 'on'
    for:
      minutes: 5
  action:
  - service: switch.turn_off
    entity_id: switch.apt01_entrance_lock

- id: b1_doorbell_pressed
  alias: B1 Doorbell Pressed
  trigger:
    - platform: numeric_state
      entity_id: sensor.b1_vdb_doorbells
      below: 2.50
      above: 0.00
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.b1_vdb_doorbells
              above: 0.00
              below: 0.90
          sequence:
            - service: switch.turn_on
              alias: Ring Apt01 Doorbell
              target:
                entity_id: switch.apt01_doorbell
            - service: input_text.set_value
              alias: Set Message Line 1
              data:
                value: Apt 1
              target:
                entity_id: input_text.b1_vdb_line1
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.b1_vdb_doorbells
              above: 1.00
              below: 1.50
          sequence:
            - service: switch.turn_on
              alias: Ring Apt02 Doorbell
              target:
                entity_id: switch.apt02_doorbell
            - service: input_text.set_value
              alias: Set Message Line 2
              data:
                value: Apt 2
              target:
                entity_id: input_text.b1_vdb_line2
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.b1_vdb_doorbells
              above: 1.60
              below: 1.80
          sequence:
            - service: switch.turn_on
              alias: Ring Apt03 Doorbell
              target:
                entity_id: switch.apt03_doorbell
            - service: input_text.set_value
              alias: Set Message Line 3
              data:
                value: Apt 3
              target:
                entity_id: input_text.b1_vdb_line3
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.b1_vdb_doorbells
              above: 1.90
              below: 2.50
          sequence:
            - service: switch.turn_on
              alias: Ring Apt04 Doorbell
              target:
                entity_id: switch.apt04_doorbell
            - service: input_text.set_value
              alias: Set Message Line 4
              data:
                value: Apt 4
              target:
                entity_id: input_text.b1_vdb_line4

- id: apt01_climate_away
  alias: Apt01 Climate Away
  trigger:
    - platform: state
      entity_id: person.apt01_jason
      to: 'not_home'
      for:
        minutes: 15
  action: 
    - service: climate.set_away_mode
      data:
        entity_id:
          - climate.apt01_heat
          - climate.apt01_ac
        away_mode: 'on'
      
- id: apt01_climate_home
  alias: Apt01 Climate Home
  trigger:
    - platform: state
      entity_id: person.apt01_jason
      to: 'home'
      for:
        minutes: 3
  action: 
    - service: climate.set_away_mode
      data:
        entity_id:
          - climate.apt01_heat
          - climate.apt01_ac
        away_mode: 'off'
    - service: light.turn_on
      data:
        entity_id:
          - apt01_bulb_entrance
          - apt01_bulb_hall
          - apt01_bulb_livingroom

- id: apt14_climate_away
  alias: Apt14 Climate Away
  trigger:
    - platform: state
      entity_id: person.apt14_derek
      to: 'not_home'
      for:
        minutes: 15
  action: 
    - service: climate.set_away_mode
      data:
        entity_id:
          - climate.apt14_heat
          - climate.apt14_ac
        away_mode: 'on'
      
- id: apt14_climate_home
  alias: Apt14 Climate Home
  trigger:
    - platform: state
      entity_id: person.apt14_derek
      to: 'home'
      for:
        minutes: 3
  action: 
    - service: climate.set_away_mode
      data:
        entity_id:
          - climate.apt14_heat
          - climate.apt14_ac
        away_mode: 'off'

- id: apt01_doorbell_button
  alias: Apt01 Doorbel Button
  trigger:
    - platform: state
      entity_id: binary_sensor.apt01_video_doorbell_button
      from: 'off'
      to: 'on'
  action:
    - service: notify.mobile_app_pixel_4_xl
      data:
        title: Knock Knock
        message: Someone is at the door.
        data:
          attachment:
            content-type: jpeg
          push:
            category: camera
          entity_id: camera.apt01_video_doorbell_camera

